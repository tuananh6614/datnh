<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Luong Hoat Dong - Smart Parking System</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Times New Roman', serif;
            background: #fff;
            padding: 40px;
        }
        .page {
            max-width: 1000px;
            margin: 0 auto;
            background: #fff;
        }
        .flow-title {
            background: #1a1a2e;
            color: #fff;
            text-align: center;
            padding: 15px 40px;
            font-size: 20px;
            font-weight: bold;
            margin: 50px auto 40px;
            display: inline-block;
            border-radius: 5px;
        }
        .flow-container {
            display: flex;
            justify-content: center;
            margin-bottom: 60px;
        }
        h2 {
            text-align: center;
            margin-bottom: 20px;
            color: #333;
            font-size: 24px;
        }
        .page-break {
            page-break-after: always;
        }
    </style>
</head>
<body>
    <div class="page">

        <!-- ==================== LUỒNG 1: XE VÀO ==================== -->
        <h2>1. Luong xe vao bai</h2>
        <div class="flow-container">
            <svg width="600" height="950" viewBox="0 0 600 950">
                <defs>
                    <marker id="arrow" markerWidth="12" markerHeight="9" refX="10" refY="4.5" orient="auto">
                        <polygon points="0 0, 12 4.5, 0 9" fill="#000"/>
                    </marker>
                </defs>

                <!-- Start -->
                <ellipse cx="300" cy="40" rx="80" ry="35" fill="#fff" stroke="#000" stroke-width="3"/>
                <text x="300" y="47" text-anchor="middle" font-size="18" font-weight="bold">Bat dau</text>

                <line x1="300" y1="75" x2="300" y2="110" stroke="#000" stroke-width="3" marker-end="url(#arrow)"/>

                <!-- 1. Xe đến cổng -->
                <rect x="150" y="115" width="300" height="60" rx="12" fill="#fff" stroke="#000" stroke-width="3"/>
                <text x="300" y="152" text-anchor="middle" font-size="18">Xe den cong vao</text>

                <line x1="300" y1="175" x2="300" y2="210" stroke="#000" stroke-width="3" marker-end="url(#arrow)"/>

                <!-- 2. Quẹt thẻ RFID -->
                <rect x="150" y="215" width="300" height="60" rx="12" fill="#fff" stroke="#000" stroke-width="3"/>
                <text x="300" y="252" text-anchor="middle" font-size="18">Quet the RFID</text>

                <line x1="300" y1="275" x2="300" y2="310" stroke="#000" stroke-width="3" marker-end="url(#arrow)"/>

                <!-- 3. ESP32 gửi MQTT -->
                <rect x="150" y="315" width="300" height="60" rx="12" fill="#fff" stroke="#000" stroke-width="3"/>
                <text x="300" y="345" text-anchor="middle" font-size="18">ESP32 gui MQTT</text>
                <text x="300" y="365" text-anchor="middle" font-size="14">(card_uid, gate_id)</text>

                <line x1="300" y1="375" x2="300" y2="410" stroke="#000" stroke-width="3" marker-end="url(#arrow)"/>

                <!-- 4. Camera chụp -->
                <rect x="150" y="415" width="300" height="60" rx="12" fill="#fff" stroke="#000" stroke-width="3"/>
                <text x="300" y="452" text-anchor="middle" font-size="18">Camera chup anh</text>

                <line x1="300" y1="475" x2="300" y2="510" stroke="#000" stroke-width="3" marker-end="url(#arrow)"/>

                <!-- 5. YOLOv8 + EasyOCR -->
                <rect x="150" y="515" width="300" height="60" rx="12" fill="#fff" stroke="#000" stroke-width="3"/>
                <text x="300" y="545" text-anchor="middle" font-size="18">YOLOv8 + EasyOCR</text>
                <text x="300" y="565" text-anchor="middle" font-size="14">(Nhan dien bien so)</text>

                <line x1="300" y1="575" x2="300" y2="610" stroke="#000" stroke-width="3" marker-end="url(#arrow)"/>

                <!-- Decision: Phát hiện được? -->
                <polygon points="300,615 420,680 300,745 180,680" fill="#fff" stroke="#000" stroke-width="3"/>
                <text x="300" y="672" text-anchor="middle" font-size="16" font-weight="bold">Phat hien</text>
                <text x="300" y="695" text-anchor="middle" font-size="16" font-weight="bold">bien so?</text>

                <!-- No - Thử lại -->
                <line x1="180" y1="680" x2="100" y2="680" stroke="#000" stroke-width="3"/>
                <line x1="100" y1="680" x2="100" y2="545" stroke="#000" stroke-width="3"/>
                <line x1="100" y1="545" x2="150" y2="545" stroke="#000" stroke-width="3" marker-end="url(#arrow)"/>
                <text x="125" y="665" font-size="16" font-weight="bold">Khong</text>

                <!-- Yes -->
                <line x1="300" y1="745" x2="300" y2="785" stroke="#000" stroke-width="3" marker-end="url(#arrow)"/>
                <text x="320" y="770" font-size="16" font-weight="bold">Co</text>

                <!-- 6. Lưu DB -->
                <rect x="150" y="790" width="300" height="60" rx="12" fill="#fff" stroke="#000" stroke-width="3"/>
                <text x="300" y="820" text-anchor="middle" font-size="18">Luu vao Database</text>
                <text x="300" y="842" text-anchor="middle" font-size="14">(UID, Bien so, Thoi gian)</text>

                <line x1="300" y1="850" x2="300" y2="885" stroke="#000" stroke-width="3" marker-end="url(#arrow)"/>

                <!-- End: Mở barrier -->
                <ellipse cx="300" cy="920" rx="90" ry="35" fill="#fff" stroke="#000" stroke-width="3"/>
                <text x="300" y="927" text-anchor="middle" font-size="18" font-weight="bold">Mo barrier</text>
            </svg>
        </div>

        <div class="flow-title">Luong xe vao bai</div>

        <div class="page-break"></div>

        <!-- ==================== LUỒNG 2: XE RA ==================== -->
        <h2>2. Luong xe ra bai</h2>
        <div class="flow-container">
            <svg width="700" height="1000" viewBox="0 0 700 1000">
                <!-- Start -->
                <ellipse cx="350" cy="40" rx="80" ry="35" fill="#fff" stroke="#000" stroke-width="3"/>
                <text x="350" y="47" text-anchor="middle" font-size="18" font-weight="bold">Bat dau</text>

                <line x1="350" y1="75" x2="350" y2="110" stroke="#000" stroke-width="3" marker-end="url(#arrow)"/>

                <!-- 1. Xe đến cổng ra -->
                <rect x="200" y="115" width="300" height="60" rx="12" fill="#fff" stroke="#000" stroke-width="3"/>
                <text x="350" y="152" text-anchor="middle" font-size="18">Xe den cong ra</text>

                <line x1="350" y1="175" x2="350" y2="210" stroke="#000" stroke-width="3" marker-end="url(#arrow)"/>

                <!-- 2. Quẹt thẻ -->
                <rect x="200" y="215" width="300" height="60" rx="12" fill="#fff" stroke="#000" stroke-width="3"/>
                <text x="350" y="252" text-anchor="middle" font-size="18">Quet the RFID</text>

                <line x1="350" y1="275" x2="350" y2="310" stroke="#000" stroke-width="3" marker-end="url(#arrow)"/>

                <!-- 3. Camera chụp -->
                <rect x="200" y="315" width="300" height="60" rx="12" fill="#fff" stroke="#000" stroke-width="3"/>
                <text x="350" y="352" text-anchor="middle" font-size="18">Camera chup anh</text>

                <line x1="350" y1="375" x2="350" y2="410" stroke="#000" stroke-width="3" marker-end="url(#arrow)"/>

                <!-- 4. AI nhận diện -->
                <rect x="200" y="415" width="300" height="60" rx="12" fill="#fff" stroke="#000" stroke-width="3"/>
                <text x="350" y="452" text-anchor="middle" font-size="18">AI nhan dien bien so</text>

                <line x1="350" y1="475" x2="350" y2="510" stroke="#000" stroke-width="3" marker-end="url(#arrow)"/>

                <!-- 5. Truy vấn DB -->
                <rect x="200" y="515" width="300" height="60" rx="12" fill="#fff" stroke="#000" stroke-width="3"/>
                <text x="350" y="545" text-anchor="middle" font-size="18">Truy van Database</text>
                <text x="350" y="567" text-anchor="middle" font-size="14">(Lay thong tin xe vao)</text>

                <line x1="350" y1="575" x2="350" y2="610" stroke="#000" stroke-width="3" marker-end="url(#arrow)"/>

                <!-- Decision: Biển số khớp? -->
                <polygon points="350,615 470,675 350,735 230,675" fill="#fff" stroke="#000" stroke-width="3"/>
                <text x="350" y="668" text-anchor="middle" font-size="16" font-weight="bold">Bien so</text>
                <text x="350" y="690" text-anchor="middle" font-size="16" font-weight="bold">khop?</text>

                <!-- No - Cảnh báo -->
                <line x1="230" y1="675" x2="100" y2="675" stroke="#000" stroke-width="3" marker-end="url(#arrow)"/>
                <text x="160" y="660" font-size="16" font-weight="bold">Khong</text>
                <rect x="20" y="650" width="100" height="50" rx="8" fill="#fff" stroke="#000" stroke-width="3"/>
                <text x="70" y="682" text-anchor="middle" font-size="16">Canh bao</text>

                <!-- Yes -->
                <line x1="350" y1="735" x2="350" y2="775" stroke="#000" stroke-width="3" marker-end="url(#arrow)"/>
                <text x="370" y="760" font-size="16" font-weight="bold">Co</text>

                <!-- Decision: Đã thanh toán? -->
                <polygon points="350,780 470,840 350,900 230,840" fill="#fff" stroke="#000" stroke-width="3"/>
                <text x="350" y="833" text-anchor="middle" font-size="16" font-weight="bold">Da thanh</text>
                <text x="350" y="855" text-anchor="middle" font-size="16" font-weight="bold">toan?</text>

                <!-- No - Yêu cầu thanh toán -->
                <line x1="470" y1="840" x2="570" y2="840" stroke="#000" stroke-width="3" marker-end="url(#arrow)"/>
                <text x="505" y="825" font-size="16" font-weight="bold">Chua</text>
                <rect x="575" y="810" width="120" height="60" rx="8" fill="#fff" stroke="#000" stroke-width="3"/>
                <text x="635" y="835" text-anchor="middle" font-size="14">Yeu cau qua</text>
                <text x="635" y="855" text-anchor="middle" font-size="14">tram thanh toan</text>

                <!-- Yes -->
                <line x1="350" y1="900" x2="350" y2="940" stroke="#000" stroke-width="3" marker-end="url(#arrow)"/>
                <text x="370" y="925" font-size="16" font-weight="bold">Roi</text>

                <!-- End: Mở barrier -->
                <ellipse cx="350" cy="970" rx="90" ry="35" fill="#fff" stroke="#000" stroke-width="3"/>
                <text x="350" y="977" text-anchor="middle" font-size="18" font-weight="bold">Mo barrier</text>
            </svg>
        </div>

        <div class="flow-title">Luong xe ra bai</div>

        <div class="page-break"></div>

        <!-- ==================== LUỒNG 3: THANH TOÁN ==================== -->
        <h2>3. Luong thanh toan</h2>
        <div class="flow-container">
            <svg width="600" height="1050" viewBox="0 0 600 1050">
                <!-- Start -->
                <ellipse cx="300" cy="40" rx="80" ry="35" fill="#fff" stroke="#000" stroke-width="3"/>
                <text x="300" y="47" text-anchor="middle" font-size="18" font-weight="bold">Bat dau</text>

                <line x1="300" y1="75" x2="300" y2="110" stroke="#000" stroke-width="3" marker-end="url(#arrow)"/>

                <!-- 1. Quẹt thẻ -->
                <rect x="150" y="115" width="300" height="60" rx="12" fill="#fff" stroke="#000" stroke-width="3"/>
                <text x="300" y="145" text-anchor="middle" font-size="18">Quet the tai tram</text>
                <text x="300" y="167" text-anchor="middle" font-size="18">thanh toan</text>

                <line x1="300" y1="175" x2="300" y2="210" stroke="#000" stroke-width="3" marker-end="url(#arrow)"/>

                <!-- 2. ESP32 đọc UID -->
                <rect x="150" y="215" width="300" height="60" rx="12" fill="#fff" stroke="#000" stroke-width="3"/>
                <text x="300" y="245" text-anchor="middle" font-size="18">ESP32 doc UID the</text>
                <text x="300" y="267" text-anchor="middle" font-size="14">(RFID RC522 #3)</text>

                <line x1="300" y1="275" x2="300" y2="310" stroke="#000" stroke-width="3" marker-end="url(#arrow)"/>

                <!-- 3. Gửi HTTP -->
                <rect x="150" y="315" width="300" height="60" rx="12" fill="#fff" stroke="#000" stroke-width="3"/>
                <text x="300" y="345" text-anchor="middle" font-size="18">Gui HTTP request</text>
                <text x="300" y="367" text-anchor="middle" font-size="14">GET /api/payment/{uid}</text>

                <line x1="300" y1="375" x2="300" y2="410" stroke="#000" stroke-width="3" marker-end="url(#arrow)"/>

                <!-- 4. Server tính phí -->
                <rect x="150" y="415" width="300" height="60" rx="12" fill="#fff" stroke="#000" stroke-width="3"/>
                <text x="300" y="445" text-anchor="middle" font-size="18">Server tinh phi</text>
                <text x="300" y="467" text-anchor="middle" font-size="14">3000 + (gio x 5000) VND</text>

                <line x1="300" y1="475" x2="300" y2="510" stroke="#000" stroke-width="3" marker-end="url(#arrow)"/>

                <!-- 5. Tạo QR -->
                <rect x="150" y="515" width="300" height="60" rx="12" fill="#fff" stroke="#000" stroke-width="3"/>
                <text x="300" y="545" text-anchor="middle" font-size="18">Tao ma VietQR</text>
                <text x="300" y="567" text-anchor="middle" font-size="14">(img.vietqr.io API)</text>

                <line x1="300" y1="575" x2="300" y2="610" stroke="#000" stroke-width="3" marker-end="url(#arrow)"/>

                <!-- 6. Hiển thị TFT -->
                <rect x="150" y="615" width="300" height="60" rx="12" fill="#fff" stroke="#000" stroke-width="3"/>
                <text x="300" y="645" text-anchor="middle" font-size="18">Hien thi len TFT</text>
                <text x="300" y="667" text-anchor="middle" font-size="14">(So tien + QR code)</text>

                <line x1="300" y1="675" x2="300" y2="710" stroke="#000" stroke-width="3" marker-end="url(#arrow)"/>

                <!-- 7. User scan QR -->
                <rect x="150" y="715" width="300" height="60" rx="12" fill="#fff" stroke="#000" stroke-width="3"/>
                <text x="300" y="745" text-anchor="middle" font-size="18">Nguoi dung scan QR</text>
                <text x="300" y="767" text-anchor="middle" font-size="14">va chuyen khoan</text>

                <line x1="300" y1="775" x2="300" y2="810" stroke="#000" stroke-width="3" marker-end="url(#arrow)"/>

                <!-- 8. SePay webhook -->
                <rect x="150" y="815" width="300" height="60" rx="12" fill="#fff" stroke="#000" stroke-width="3"/>
                <text x="300" y="845" text-anchor="middle" font-size="18">SePay gui Webhook</text>
                <text x="300" y="867" text-anchor="middle" font-size="14">(callback: thanh toan OK)</text>

                <line x1="300" y1="875" x2="300" y2="910" stroke="#000" stroke-width="3" marker-end="url(#arrow)"/>

                <!-- 9. Cập nhật DB -->
                <rect x="150" y="915" width="300" height="60" rx="12" fill="#fff" stroke="#000" stroke-width="3"/>
                <text x="300" y="952" text-anchor="middle" font-size="18">Cap nhat: paid = true</text>

                <line x1="300" y1="975" x2="300" y2="1000" stroke="#000" stroke-width="3" marker-end="url(#arrow)"/>

                <!-- End -->
                <ellipse cx="300" cy="1030" rx="100" ry="30" fill="#fff" stroke="#000" stroke-width="3"/>
                <text x="300" y="1037" text-anchor="middle" font-size="16" font-weight="bold">Thanh toan xong</text>
            </svg>
        </div>

        <div class="flow-title">Luong thanh toan</div>

        <!-- Chú thích -->
        <div style="margin-top: 50px; padding: 25px; border: 2px solid #000;">
            <h3 style="margin-bottom: 20px; font-size: 20px;">Chu thich ky hieu:</h3>
            <svg width="700" height="80">
                <ellipse cx="60" cy="35" rx="50" ry="25" fill="#fff" stroke="#000" stroke-width="3"/>
                <text x="60" y="42" text-anchor="middle" font-size="14">Start/End</text>

                <rect x="150" y="15" width="100" height="45" rx="10" fill="#fff" stroke="#000" stroke-width="3"/>
                <text x="200" y="45" text-anchor="middle" font-size="14">Process</text>

                <polygon points="350,15 410,37 350,60 290,37" fill="#fff" stroke="#000" stroke-width="3"/>
                <text x="350" y="43" text-anchor="middle" font-size="12">Decision</text>

                <line x1="450" y1="37" x2="550" y2="37" stroke="#000" stroke-width="3" marker-end="url(#arrow)"/>
                <text x="500" y="65" text-anchor="middle" font-size="14">Flow</text>
            </svg>
        </div>

    </div>
</body>
</html>
